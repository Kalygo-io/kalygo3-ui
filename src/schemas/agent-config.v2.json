{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://kalygo.example/schemas/agent-config-v2.schema.json",
  "title": "Agent Config v2",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema",
    "version",
    "data"
  ],
  "properties": {
    "schema": {
      "type": "string",
      "const": "agent_config"
    },
    "version": {
      "type": "integer",
      "const": 2
    },
    "data": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "systemPrompt"
      ],
      "properties": {
        "systemPrompt": {
          "type": "string",
          "minLength": 1,
          "description": "The system prompt that defines the agent's behavior and personality."
        },
        "tools": {
          "type": "array",
          "minItems": 0,
          "description": "Array of tools available to the agent. Can be empty for simple chat agents. Each tool extends the agent's capabilities.",
          "items": {
            "$ref": "#/$defs/tool"
          },
          "default": []
        }
      }
    }
  },
  "$defs": {
    "tool": {
      "type": "object",
      "description": "A tool that the agent can use. Tool type determines available properties.",
      "required": [
        "type"
      ],
      "oneOf": [
        {
          "$ref": "#/$defs/vectorSearchTool"
        },
        {
          "$ref": "#/$defs/vectorSearchWithRerankingTool"
        },
        {
          "$ref": "#/$defs/dbTableReadTool"
        },
        {
          "$ref": "#/$defs/dbTableWriteTool"
        }
      ]
    },
    "vectorSearchTool": {
      "type": "object",
      "description": "Vector database search tool for semantic retrieval from knowledge bases.",
      "additionalProperties": false,
      "required": [
        "type",
        "provider",
        "index",
        "namespace"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "vectorSearch",
          "description": "Tool type identifier."
        },
        "provider": {
          "type": "string",
          "enum": [
            "pinecone"
          ],
          "description": "Vector database provider (currently supports: pinecone)."
        },
        "index": {
          "type": "string",
          "minLength": 1,
          "description": "The name of the vector database index/collection to query."
        },
        "namespace": {
          "type": "string",
          "minLength": 1,
          "description": "The namespace/partition within the index to search."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of what this knowledge base contains. Helps the LLM decide when to use this tool."
        },
        "topK": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 10,
          "description": "Number of top results to return from vector search."
        }
      }
    },
    "vectorSearchWithRerankingTool": {
      "type": "object",
      "description": "Vector database search with re-ranking for improved relevance. Retrieves more candidates (topK) and re-ranks them to return the most relevant subset (topN).",
      "additionalProperties": false,
      "required": [
        "type",
        "provider",
        "index",
        "namespace"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "vectorSearchWithReranking",
          "description": "Tool type identifier."
        },
        "provider": {
          "type": "string",
          "enum": [
            "pinecone"
          ],
          "description": "Vector database provider (currently supports: pinecone)."
        },
        "index": {
          "type": "string",
          "minLength": 1,
          "description": "The name of the vector database index/collection to query."
        },
        "namespace": {
          "type": "string",
          "minLength": 1,
          "description": "The namespace/partition within the index to search."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of what this knowledge base contains. Helps the LLM decide when to use this tool."
        },
        "topK": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 20,
          "description": "Number of initial candidates to retrieve from vector search before re-ranking."
        },
        "topN": {
          "type": "integer",
          "minimum": 1,
          "maximum": 50,
          "default": 5,
          "description": "Number of final results to return after re-ranking."
        }
      }
    },
    "dbTableReadTool": {
      "type": "object",
      "description": "Database read tool for querying structured data from an external database. Requires a stored credential with the database connection string.",
      "additionalProperties": false,
      "required": [
        "type",
        "credentialId",
        "table"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "dbTableRead",
          "description": "Tool type identifier."
        },
        "credentialId": {
          "type": "integer",
          "minimum": 1,
          "description": "ID of the stored credential containing the database connection string. The credential must have credential_type='db_connection' and contain a 'connection_string' key."
        },
        "table": {
          "type": "string",
          "minLength": 1,
          "description": "The database table to query."
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 50,
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Optional custom name for the tool (e.g., 'query_users', 'query_orders'). If not provided, defaults to 'query_{table}'. Must be lowercase with underscores only."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of what this table contains and what queries are useful. Helps the LLM decide when and how to use this tool."
        },
        "columns": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "description": "List of columns to expose to the agent. Only these columns can be queried and returned. Required for security - prevents exposing sensitive columns."
        },
        "maxLimit": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1000,
          "default": 100,
          "description": "Maximum number of rows the agent can request in a single query."
        }
      }
    },
    "dbTableWriteTool": {
      "type": "object",
      "description": "Database write tool for inserting records into an external database table. Requires a stored credential with the database connection string.",
      "additionalProperties": false,
      "required": [
        "type",
        "credentialId",
        "table",
        "columns"
      ],
      "properties": {
        "type": {
          "type": "string",
          "const": "dbTableWrite",
          "description": "Tool type identifier."
        },
        "credentialId": {
          "type": "integer",
          "minimum": 1,
          "description": "ID of the stored credential containing the database connection string. The credential must have credential_type='db_connection' and contain a 'connection_string' key."
        },
        "table": {
          "type": "string",
          "minLength": 1,
          "description": "The database table to insert records into."
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 50,
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Optional custom name for the tool (e.g., 'create_lead', 'add_order'). If not provided, defaults to 'insert_{table}'. Must be lowercase with underscores only."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of what records this tool creates. Helps the LLM decide when and how to use this tool."
        },
        "columns": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "minItems": 1,
          "description": "List of columns that can be written. Only these columns can be set when inserting. Required for security."
        },
        "requiredColumns": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "default": [],
          "description": "List of columns that must be provided when inserting. Must be a subset of 'columns'."
        },
        "injectAccountId": {
          "type": "boolean",
          "default": false,
          "description": "If true, automatically inject the authenticated user's account_id into the record. Use this when the target table has an account_id column that should be set to the current user's account."
        }
      }
    }
  }
}